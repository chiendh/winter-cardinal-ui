{"version":3,"file":"d-application-layer.js","sourceRoot":"","sources":["../../../src/main/typescript/wcardinal/ui/d-application-layer.ts"],"names":[],"mappings":"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","sourcesContent":["/*\r\n * Copyright (C) 2019 Toshiba Corporation\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\nimport { Application, interaction, Point } from \"pixi.js\";\r\nimport { DApplicationLayerLike } from \"./d-application-layer-like\";\r\nimport { DApplicationLayerOptions } from \"./d-application-layer-options\";\r\nimport { DApplicationLike } from \"./d-application-like\";\r\nimport { DBase } from \"./d-base\";\r\nimport { DControllerDefaultFocus } from \"./d-controller-default-focus\";\r\nimport { DControllerFocus, DFocusable, DFocusableContainer } from \"./d-controller-focus\";\r\nimport { DControllers } from \"./d-controllers\";\r\nimport { DPadding } from \"./d-padding\";\r\nimport { DynamicFontAtlases } from \"./util/dynamic-font-atlases\";\r\nimport { UtilPointerEvent } from \"./util/util-pointer-event\";\r\nimport { UtilWheelEvent, UtilWheelEventDeltas } from \"./util/util-wheel-event\";\r\n\r\ninterface DblClickable {\r\n\tonDblClick( e: MouseEvent | TouchEvent, interactionManager: interaction.InteractionManager ): boolean;\r\n}\r\n\r\nconst isDblClickable = ( target: any ): target is DblClickable => {\r\n\treturn target != null && target.onDblClick != null;\r\n};\r\n\r\ninterface Wheelable {\r\n\tonWheel( e: WheelEvent, deltas: UtilWheelEventDeltas, global: Point ): boolean;\r\n}\r\n\r\nconst isWheelable = ( target: any ): target is Wheelable => {\r\n\treturn target != null && target.onWheel != null;\r\n};\r\n\r\nexport class DApplicationLayer extends Application implements DApplicationLayerLike {\r\n\tprotected _options: DApplicationLayerOptions;\r\n\tprotected _renderId: number | null = null;\r\n\tprotected _renderBound: () => void;\r\n\tprotected _isUpdateAllowed: boolean;\r\n\tprotected _refitLimit: number;\r\n\tprotected _reflowLimit: number;\r\n\tprotected _focus?: DControllerFocus;\r\n\tprotected _elementContainer: HTMLDivElement;\r\n\tprotected _dynamicFontAtlases: DynamicFontAtlases | null = null;\r\n\tprotected _isVisible: boolean;\r\n\r\n\treadonly application: DApplicationLike;\r\n\r\n\tconstructor( application: DApplicationLike, options: DApplicationLayerOptions ) {\r\n\t\tsuper( options.getPixiApplicationOptions() );\r\n\r\n\t\tthis.application = application;\r\n\t\tconst stageAny = this.stage as any;\r\n\t\tstageAny.layer = this;\r\n\t\tstageAny.application = application;\r\n\r\n\t\tthis._options = options;\r\n\t\tthis._isUpdateAllowed = true;\r\n\t\tthis._refitLimit = 5;\r\n\t\tthis._reflowLimit = 5;\r\n\t\tthis._isVisible = true;\r\n\r\n\t\tthis._renderBound = (): void => {\r\n\t\t\tif( this._renderId != null ) {\r\n\t\t\t\tthis.render();\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\t// Canvas initialization\r\n\t\tconst rootElement = options.getRootElement();\r\n\t\tconst elementContainer = document.createElement( \"div\" );\r\n\t\telementContainer.setAttribute( \"style\",\r\n\t\t\t\"position: absolute; top: 0; left: 0; width: 0; height: 0;\" +\r\n\t\t\t\"margin: 0; padding: 0; outline: none;\"\r\n\t\t);\r\n\t\tthis._elementContainer = elementContainer;\r\n\t\tconst children = rootElement.children;\r\n\t\tif( options.isOverlay() ) {\r\n\t\t\tif( 3 <= children.length ) {\r\n\t\t\t\tconst thirdChild = children[ 2 ];\r\n\t\t\t\trootElement.insertBefore( this.view, thirdChild );\r\n\t\t\t\trootElement.insertBefore( elementContainer, thirdChild );\r\n\t\t\t} else {\r\n\t\t\t\trootElement.appendChild( this.view );\r\n\t\t\t\trootElement.appendChild( elementContainer );\r\n\t\t\t}\r\n\r\n\t\t\tconst oldOnChildrenChange = stageAny.onChildrenChange;\r\n\t\t\tstageAny.onChildrenChange = () => {\r\n\t\t\t\tthis.updateVisibility();\r\n\t\t\t\toldOnChildrenChange.call( stageAny );\r\n\t\t\t};\r\n\t\t} else {\r\n\t\t\tif( 0 < children.length ) {\r\n\t\t\t\tconst firstChild = children[ 0 ];\r\n\t\t\t\trootElement.insertBefore( this.view, firstChild );\r\n\t\t\t\trootElement.insertBefore( elementContainer, firstChild );\r\n\t\t\t} else {\r\n\t\t\t\trootElement.appendChild( this.view );\r\n\t\t\t\trootElement.appendChild( elementContainer );\r\n\t\t\t}\r\n\t\t}\r\n\t\tconst rootElementStyle = rootElement.style;\r\n\t\tif( rootElement !== document.body ) {\r\n\t\t\tconst rootElementStylePosition = window.getComputedStyle( rootElement ).position;\r\n\t\t\tif( rootElementStylePosition === \"static\" ) {\r\n\t\t\t\trootElementStyle.position = \"relative\";\r\n\t\t\t}\r\n\t\t}\r\n\t\trootElementStyle.margin = \"0\";\r\n\t\trootElementStyle.padding = \"0\";\r\n\t\trootElementStyle.overflow = \"hidden\";\r\n\t\tconst viewStyle = this.view.style;\r\n\t\tviewStyle.position = \"absolute\";\r\n\t\tviewStyle.top = \"0\";\r\n\t\tviewStyle.left = \"0\";\r\n\t\tviewStyle.width = \"100%\";\r\n\t\tviewStyle.height = \"100%\";\r\n\t\tviewStyle.display = \"block\";\r\n\t\tviewStyle.outline = \"none\";\r\n\r\n\t\t// Focus handling\r\n\t\tlet hasFocus = false;\r\n\t\tconst focusController = this.getFocusController();\r\n\t\tconst onBlurBound = (): void => {\r\n\t\t\tif( ! hasFocus ) {\r\n\t\t\t\tfocusController.setFocused( null, true, false );\r\n\t\t\t}\r\n\t\t};\r\n\t\trootElement.addEventListener( \"focus\", ( e ): void => {\r\n\t\t\thasFocus = true;\r\n\t\t}, true );\r\n\t\trootElement.addEventListener( \"blur\", ( e ): void => {\r\n\t\t\thasFocus = false;\r\n\t\t\tsetTimeout( onBlurBound, 0 );\r\n\t\t}, true );\r\n\t\tthis.view.setAttribute( \"tabindex\", \"0\" );\r\n\r\n\t\tDControllers.getKeyboardController().init( this.view, this.stage, focusController );\r\n\r\n\t\tconst interactionManager: interaction.InteractionManager = this.renderer.plugins.interaction;\r\n\t\tinteractionManager.on( UtilPointerEvent.down, ( e: interaction.InteractionEvent ): void => {\r\n\t\t\tif( e.target == null ) {\r\n\t\t\t\tfocusController.setFocused( null, true, false );\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// Resize handling\r\n\t\tconst onResize = (): void => {\r\n\t\t\tconst bbox = options.getRootElement().getBoundingClientRect();\r\n\t\t\tthis.renderer.resize( bbox.width, bbox.height );\r\n\t\t\tthis.resizeChildren( bbox.width, bbox.height, options.getPadding() );\r\n\t\t\tthis.update();\r\n\t\t};\r\n\t\twindow.addEventListener( \"resize\", onResize );\r\n\t\twindow.addEventListener( \"orientationchange\", onResize );\r\n\r\n\t\t// Mouse wheel handling\r\n\t\tconst wheelGlobal = new Point();\r\n\t\tconst wheelEventUtil = UtilWheelEvent.getInstance();\r\n\t\twheelEventUtil.on( this.view, ( e: WheelEvent | Event ): void => {\r\n\t\t\tconst wheelEvent = e as WheelEvent;\r\n\t\t\tUtilPointerEvent.toGlobal( wheelEvent, interactionManager, wheelGlobal );\r\n\t\t\tlet current = interactionManager.hitTest( wheelGlobal );\r\n\t\t\tconst deltas = wheelEventUtil.normalize( e );\r\n\t\t\tif( deltas != null ) {\r\n\t\t\t\twhile( current != null ) {\r\n\t\t\t\t\tif( isWheelable( current ) ) {\r\n\t\t\t\t\t\tif( current.onWheel( wheelEvent, deltas, wheelGlobal ) ) {\r\n\t\t\t\t\t\t\twheelEvent.preventDefault();\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcurrent = current.parent;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// Double click handling\r\n\t\tUtilPointerEvent.onDblClick( this.view, ( e: MouseEvent | TouchEvent ) => {\r\n\t\t\tconst focused = focusController.getFocused();\r\n\t\t\tif( focused != null ) {\r\n\t\t\t\tlet current: DFocusable | DFocusableContainer | null = focused;\r\n\t\t\t\twhile( current != null ) {\r\n\t\t\t\t\tif( isDblClickable( current ) ) {\r\n\t\t\t\t\t\tif( current.onDblClick( e, interactionManager ) ) {\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcurrent = current.parent;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t//\r\n\t\tthis.stage.interactive = true;\r\n\t}\r\n\r\n\tdisallowUpdate(): void {\r\n\t\tthis._isUpdateAllowed = false;\r\n\t}\r\n\r\n\tallowUpdate(): void {\r\n\t\tthis._isUpdateAllowed = true;\r\n\t}\r\n\r\n\tupdate(): void {\r\n\t\tif( this._isUpdateAllowed && this._renderId == null ) {\r\n\t\t\tthis._renderId = requestAnimationFrame( this._renderBound );\r\n\t\t}\r\n\t}\r\n\r\n\tprotected updateVisibility(): void {\r\n\t\tif( this._options.isOverlay() ) {\r\n\t\t\tif( 0 < this.stage.children.length ) {\r\n\t\t\t\tif( ! this._isVisible ) {\r\n\t\t\t\t\tthis._isVisible = true;\r\n\t\t\t\t\tthis.view.style.display = \"block\";\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif( this._isVisible ) {\r\n\t\t\t\t\tthis._isVisible = false;\r\n\t\t\t\t\tthis.view.style.display = \"none\";\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\trender(): void {\r\n\t\tthis.refit();\r\n\t\tthis.reflow();\r\n\r\n\t\t// Please note why the following line is here.\r\n\t\t//\r\n\t\t// Before this line, the update method does not enque a rendering task\r\n\t\t// because `this._renderId` is not null. As a result, this prevents\r\n\t\t// an unintentional rendering loop caused by the refit or the reflow.\r\n\t\t//\r\n\t\t// After this line, the update method enques a rendering task.\r\n\t\t// Namely, in the DisplayObject#render(Renderer) method, allowed to enque\r\n\t\t// a rendering task. For instance, please refer to the DDiagramShape#update().\r\n\t\tthis._renderId = null;\r\n\r\n\t\t// Render\r\n\t\tsuper.render();\r\n\t}\r\n\r\n\tget width(): number {\r\n\t\treturn this.screen.width;\r\n\t}\r\n\r\n\tget height(): number {\r\n\t\treturn this.screen.height;\r\n\t}\r\n\r\n\tget padding(): DPadding {\r\n\t\treturn this._options.getPadding();\r\n\t}\r\n\r\n\tprotected resizeChildren( width: number, height: number, padding: DPadding ): void {\r\n\t\tconst children = this.stage.children;\r\n\t\tfor( let i = 0, imax = children.length; i < imax; ++i ) {\r\n\t\t\tconst child = children[ i ];\r\n\t\t\tif( child instanceof DBase ) {\r\n\t\t\t\tchild.onParentResize( width, height, padding );\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\trefit(): void {\r\n\t\tconst children = this.stage.children;\r\n\t\tfor( let ilimit = 0, limit = this._refitLimit; ilimit < limit; ++ilimit ) {\r\n\t\t\tlet isChildrenDirty = false;\r\n\t\t\tfor( let i = 0, imax = children.length; i < imax; ++i ) {\r\n\t\t\t\tconst child = children[ i ];\r\n\t\t\t\tif( child instanceof DBase ) {\r\n\t\t\t\t\tchild.refit();\r\n\t\t\t\t\tisChildrenDirty = isChildrenDirty || child.isChildrenDirty();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// If DBases are changed during the `refit` process, need to refit again.\r\n\t\t\tif( ! isChildrenDirty ) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\treflow(): void {\r\n\t\tconst children = this.stage.children;\r\n\t\tfor( let ilimit = 0, limit = this._refitLimit; ilimit < limit; ++ilimit ) {\r\n\t\t\tlet isDirty = false;\r\n\t\t\tfor( let i = 0, imax = children.length; i < imax; ++i ) {\r\n\t\t\t\tconst child = children[ i ];\r\n\t\t\t\tif( child instanceof DBase ) {\r\n\t\t\t\t\tchild.reflow();\r\n\t\t\t\t\tisDirty = isDirty || child.isDirty() || child.hasDirty();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// If DBases are changed during the `reflow` process, need to reflow again.\r\n\t\t\tif( ! isDirty ) {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tgetFocusController(): DControllerFocus {\r\n\t\tif( this._focus == null ) {\r\n\t\t\tthis._focus = new DControllerDefaultFocus();\r\n\t\t}\r\n\t\treturn this._focus;\r\n\t}\r\n\r\n\tgetElementContainer(): HTMLElement {\r\n\t\treturn this._elementContainer;\r\n\t}\r\n\r\n\tgetDynamicFontAtlases(): DynamicFontAtlases {\r\n\t\tif( this._dynamicFontAtlases == null ) {\r\n\t\t\tthis._dynamicFontAtlases = new DynamicFontAtlases( this );\r\n\t\t}\r\n\t\treturn this._dynamicFontAtlases;\r\n\t}\r\n}\r\n"]}