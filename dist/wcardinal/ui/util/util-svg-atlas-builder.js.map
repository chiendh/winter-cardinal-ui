{"version":3,"file":"util-svg-atlas-builder.js","sourceRoot":"","sources":["../../../../src/main/typescript/wcardinal/ui/util/util-svg-atlas-builder.ts"],"names":[],"mappings":"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","sourcesContent":["/*\r\n * Copyright (C) 2019 Toshiba Corporation\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\nimport { BaseTexture, Rectangle, resources, SCALE_MODES, Texture } from \"pixi.js\";\r\nimport { SVGResource } from \"../resource/svg-resource\";\r\nimport { toSvgUrl } from \"./to-svg-url\";\r\n\r\n// PixiJS's SVGResource has a issue on Microsoft Edge.\r\n// Edge may invoke the HTMLImageElement#onload on an unexpected timing.\r\n// Thus, PixiJS may lost the `load` event in some situations.\r\nresources.INSTALLED.push( SVGResource );\r\n\r\nexport interface UtilSvgAtlasBuilderBuildOptions {\r\n\tforce?: boolean;\r\n\tscaling?: SCALE_MODES;\r\n\tresolution?: number;\r\n}\r\n\r\nexport class UtilSvgAtlasBuilder {\r\n\tprotected _width: number;\r\n\tprotected _ratio: number;\r\n\tprotected _margin: number;\r\n\r\n\tprotected _frames: { [ name: string ]: Rectangle };\r\n\tprotected _svg: string;\r\n\tprotected _nextX: number;\r\n\tprotected _nextY: number;\r\n\tprotected _height: number;\r\n\r\n\tprotected _built?: { [ name: string ]: Texture };\r\n\r\n\tconstructor( width: number, ratio: number, margin: number ) {\r\n\t\tthis._width = width;\r\n\t\tthis._ratio = ratio;\r\n\t\tthis._margin = margin;\r\n\r\n\t\tthis._frames = {};\r\n\t\tthis._svg = \"\";\r\n\t\tthis._nextX = 0;\r\n\t\tthis._nextY = 0;\r\n\t\tthis._height = 0;\r\n\t}\r\n\r\n\tget width(): number {\r\n\t\treturn this._width;\r\n\t}\r\n\r\n\tget ratio(): number {\r\n\t\treturn this._ratio;\r\n\t}\r\n\r\n\tget margin(): number {\r\n\t\treturn this._margin;\r\n\t}\r\n\r\n\tadd( name: string, width: number, height: number, path: string ): boolean {\r\n\t\tconst frames = this._frames;\r\n\t\tif( ! ( name in frames ) ) {\r\n\t\t\t// Position\r\n\t\t\tconst margin = this._margin;\r\n\t\t\tlet x = this._nextX;\r\n\t\t\tlet y = this._nextY;\r\n\t\t\tif( this._width <= x + width ) {\r\n\t\t\t\tx = 0;\r\n\t\t\t\ty = this._nextY + this._height + margin;\r\n\t\t\t\tthis._height = height;\r\n\t\t\t\tthis._nextY = y;\r\n\t\t\t} else {\r\n\t\t\t\tthis._height = Math.max( this._height, height );\r\n\t\t\t}\r\n\t\t\tthis._nextX = x + width + margin;\r\n\r\n\t\t\t// Frame\r\n\t\t\tframes[ name ] = new Rectangle( x, y, width, height );\r\n\r\n\t\t\t// Svg\r\n\t\t\tconst ratio = this._ratio;\r\n\t\t\tthis._svg += `<g transform=\"translate(${x * ratio},${y * ratio})\">${path}</g>`;\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tget mappings(): { [ name: string ]: Texture } {\r\n\t\treturn this.build();\r\n\t}\r\n\r\n\tbuild( options?: UtilSvgAtlasBuilderBuildOptions ): { [ name: string ]: Texture } {\r\n\t\tlet built = this._built;\r\n\t\tif( built == null || (options && options.force) ) {\r\n\t\t\tconst resolution = ( options && options.resolution != null ?\r\n\t\t\t\toptions.resolution : (window.devicePixelRatio || 1)\r\n\t\t\t);\r\n\t\t\tconst width = this._width;\r\n\t\t\tconst height = Math.pow( 2, Math.ceil( Math.log( this._nextY + this._height ) / Math.LN2 ) );\r\n\t\t\tconst realWidth = width * resolution;\r\n\t\t\tconst realHeight = height * resolution;\r\n\t\t\tconst ratio = this._ratio;\r\n\t\t\tconst attrWidth = `width=\"${realWidth}\"`;\r\n\t\t\tconst attrHeight = `height=\"${realHeight}\"`;\r\n\t\t\tconst attrViewBox = `viewBox=\"0 0 ${width * ratio} ${height * ratio}\"`;\r\n\t\t\tconst attrXmlns = `xmlns=\"http://www.w3.org/2000/svg\"`;\r\n\t\t\tconst url = toSvgUrl( `<svg ${attrWidth} ${attrHeight} ${attrViewBox} ${attrXmlns}>${this._svg}</svg>` );\r\n\t\t\tconst scaleMode = (options && options.scaling != null ? options.scaling : SCALE_MODES.NEAREST);\r\n\t\t\tconst baseTexture = BaseTexture.from( url, {\r\n\t\t\t\tresolution,\r\n\t\t\t\tscaleMode\r\n\t\t\t});\r\n\t\t\tconst frames = this._frames;\r\n\t\t\tbuilt = this._built = {};\r\n\t\t\tfor( const name in frames ) {\r\n\t\t\t\tbuilt[ name ] = new Texture( baseTexture, frames[ name ] );\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn built;\r\n\t}\r\n}\r\n"]}