{"version":3,"file":"util-drag-easing.js","sourceRoot":"","sources":["../../../../src/main/typescript/wcardinal/ui/util/util-drag-easing.ts"],"names":[],"mappings":"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","sourcesContent":["/*\r\n * Copyright (C) 2019 Toshiba Corporation\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\nimport { DAnimation } from \"../d-animation\";\r\nimport { DAnimationBase } from \"../d-animation-base\";\r\nimport { DAnimationTimings } from \"../d-animation-timings\";\r\nimport { isNumber } from \"./is-number\";\r\nimport { UtilDragEasingHistory } from \"./util-drag-easing-history\";\r\n\r\nexport type UtilDragEasingOnMove = ( dx: number, dy: number, ds: number, time: number ) => void;\r\n\r\nexport interface UtilDragEasingDurationOptions {\r\n\tposition?: number;\r\n\tscale?: number;\r\n}\r\n\r\nexport interface UtilDragEasingOptions {\r\n\tduration?: number | UtilDragEasingDurationOptions;\r\n}\r\n\r\nexport class UtilDragEasing {\r\n\tprotected static HISTORY_CAPACITY = 5;\r\n\tprotected _histories: UtilDragEasingHistory[];\r\n\tprotected _historiesSorted: UtilDragEasingHistory[];\r\n\tprotected _historyBegin: number;\r\n\tprotected _historyEnd: number;\r\n\tprotected _animation: DAnimation;\r\n\tprotected _dx: number;\r\n\tprotected _dy: number;\r\n\tprotected _dt: number;\r\n\tprotected _ds: number;\r\n\tprotected _durationPosition: number;\r\n\tprotected _durationScale: number;\r\n\tprotected _onMove: UtilDragEasingOnMove;\r\n\r\n\tconstructor( onMove: UtilDragEasingOnMove, options?: UtilDragEasingOptions ) {\r\n\t\tthis._histories = [];\r\n\t\tthis._historiesSorted = [];\r\n\t\tthis._historyBegin = 0;\r\n\t\tthis._historyEnd = -1;\r\n\t\tthis._dx = 0;\r\n\t\tthis._dy = 0;\r\n\t\tthis._ds = 0;\r\n\t\tthis._dt = 0;\r\n\t\tthis._animation = new DAnimationBase({\r\n\t\t\tonTime: ( t: number ): void => {\r\n\t\t\t\tthis.onEase( t );\r\n\t\t\t},\r\n\t\t\ttiming: DAnimationTimings.LINEAR,\r\n\t\t\tduration: 1000\r\n\t\t});\r\n\t\tconst duration = options && options.duration;\r\n\t\tif( duration ) {\r\n\t\t\tif( isNumber( duration ) ) {\r\n\t\t\t\tthis._durationPosition = duration;\r\n\t\t\t\tthis._durationScale = duration;\r\n\t\t\t} else {\r\n\t\t\t\tthis._durationPosition = ( duration.position != null ? duration.position : 1 );\r\n\t\t\t\tthis._durationScale = ( duration.scale != null ? duration.scale : 1 );\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis._durationPosition = 1;\r\n\t\t\tthis._durationScale = 1;\r\n\t\t}\r\n\t\tthis._onMove = onMove;\r\n\t}\r\n\r\n\tonStart(): void {\r\n\t\t// History\r\n\t\tconst histories = this._histories;\r\n\t\tfor( let i = histories.length, imax = UtilDragEasing.HISTORY_CAPACITY; i < imax; ++i ) {\r\n\t\t\thistories.push( new UtilDragEasingHistory( 0, 0, 1, 0 ) );\r\n\t\t}\r\n\t\tthis._historyBegin = 0;\r\n\t\tthis._historyEnd = -1;\r\n\r\n\t\t// Stop animation\r\n\t\tthis._animation.stop();\r\n\t}\r\n\r\n\tonMove( dx: number, dy: number, ds: number, dt: number ): void {\r\n\t\tconst capacity = UtilDragEasing.HISTORY_CAPACITY;\r\n\r\n\t\tconst oldHistoryEnd = this._historyEnd;\r\n\t\tconst newHistoryEnd = (oldHistoryEnd + 1) % capacity;\r\n\t\tthis._historyEnd = newHistoryEnd;\r\n\r\n\t\tconst oldHistoryBegin = this._historyBegin;\r\n\t\tif( newHistoryEnd < oldHistoryEnd || (0 <= oldHistoryEnd && oldHistoryEnd < oldHistoryBegin) ) {\r\n\t\t\tthis._historyBegin = (oldHistoryBegin + 1) % capacity;\r\n\t\t}\r\n\r\n\t\tthis._histories[ newHistoryEnd ].set( dx, dy, ds, dt );\r\n\t}\r\n\r\n\tprotected updateHistoriesSorted( dt: number ): number {\r\n\t\tconst unsorted = this._histories;\r\n\t\tconst sorted = this._historiesSorted;\r\n\t\tconst begin = this._historyBegin;\r\n\t\tconst end = this._historyEnd;\r\n\t\tconst length = unsorted.length;\r\n\t\tconst threshold = 160;\r\n\t\tif( end < 0 ) {\r\n\t\t\tsorted.length = 0;\r\n\t\t\treturn dt;\r\n\t\t} else if( end < begin ) {\r\n\t\t\tlet total = dt;\r\n\t\t\tsorted.length = 0;\r\n\t\t\tfor( let i = end; 0 <= i; --i ) {\r\n\t\t\t\tconst history = unsorted[ i ];\r\n\t\t\t\tif( total + history.dt < threshold ) {\r\n\t\t\t\t\ttotal += history.dt;\r\n\t\t\t\t\tsorted.push( history );\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn total;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tfor( let i = length - 1; begin <= i; --i ) {\r\n\t\t\t\tconst history = unsorted[ i ];\r\n\t\t\t\tif( total + history.dt < threshold ) {\r\n\t\t\t\t\ttotal += history.dt;\r\n\t\t\t\t\tsorted.push( history );\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn total;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn total;\r\n\t\t} else {\r\n\t\t\tlet total = dt;\r\n\t\t\tsorted.length = 0;\r\n\t\t\tfor( let i = end; begin <= i; --i ) {\r\n\t\t\t\tconst history = unsorted[ i ];\r\n\t\t\t\tif( total + history.dt < threshold ) {\r\n\t\t\t\t\ttotal += history.dt;\r\n\t\t\t\t\tsorted.push( history );\r\n\t\t\t\t} else {\r\n\t\t\t\t\treturn total;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn total;\r\n\t\t}\r\n\t}\r\n\r\n\tonEnd( ldt: number ): void {\r\n\t\tconst adt = this.updateHistoriesSorted( ldt );\r\n\t\tconst sorted = this._historiesSorted;\r\n\t\tconst sortedLength = sorted.length;\r\n\t\tif( 0 < sortedLength ) {\r\n\t\t\tlet dx = 0;\r\n\t\t\tlet dy = 0;\r\n\t\t\tlet ds = 0;\r\n\t\t\tlet dt = 0;\r\n\t\t\tfor( let i = 0; i < sortedLength; ++i ) {\r\n\t\t\t\tconst history = sorted[ i ];\r\n\t\t\t\tdx += history.dx;\r\n\t\t\t\tdy += history.dy;\r\n\t\t\t\tds += history.ds;\r\n\t\t\t\tdt += history.dt;\r\n\t\t\t}\r\n\t\t\tconst w = (1 - ldt / adt) / sortedLength;\r\n\t\t\tdx *= w;\r\n\t\t\tdy *= w;\r\n\t\t\tds = 1 + (ds - sortedLength) * w;\r\n\t\t\tdt *= w;\r\n\t\t\tthis._dx = dx;\r\n\t\t\tthis._dy = dy;\r\n\t\t\tthis._ds = ds;\r\n\t\t\tthis._dt = dt;\r\n\r\n\t\t\t// Start animation\r\n\t\t\tconst d0 = this._durationPosition * 40 * Math.sqrt( dx * dx + dy * dy );\r\n\t\t\tconst d1 = this._durationScale * 10000 * Math.abs( ds - 1 );\r\n\t\t\tconst animation = this._animation;\r\n\t\t\tanimation.duration = Math.max( d0, d1 );\r\n\t\t\tanimation.start();\r\n\t\t}\r\n\t}\r\n\r\n\tprotected onEase( time: number ): void {\r\n\t\tconst w = 1 - time;\r\n\t\tthis._onMove(\r\n\t\t\tthis._dx * w,\r\n\t\t\tthis._dy * w,\r\n\t\t\t1 + ( this._ds - 1 ) * w,\r\n\t\t\ttime\r\n\t\t);\r\n\t}\r\n\r\n\tstop(): void {\r\n\t\tthis._animation.stop();\r\n\t}\r\n}\r\n"]}