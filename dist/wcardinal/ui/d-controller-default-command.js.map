{"version":3,"file":"d-controller-default-command.js","sourceRoot":"","sources":["../../../src/main/typescript/wcardinal/ui/d-controller-default-command.ts"],"names":[],"mappings":"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","sourcesContent":["/*\r\n * Copyright (C) 2019 Toshiba Corporation\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\nimport { utils } from \"pixi.js\";\r\nimport { DCommand } from \"./d-command\";\r\nimport { DCommandClear } from \"./d-command-clear\";\r\nimport { DCommandFlag } from \"./d-command-flag\";\r\nimport { DCommandRedo } from \"./d-command-redo\";\r\nimport { DCommandUndo } from \"./d-command-undo\";\r\nimport { DControllerCommand } from \"./d-controller-command\";\r\n\r\nconst isCommandStorable = ( command: DCommand ): boolean => {\r\n\treturn ( command.getFlag() & DCommandFlag.UNSTORABLE ) === 0;\r\n};\r\n\r\nconst isCommandClear = ( command: DCommand ): boolean => {\r\n\treturn ( command.getFlag() & DCommandFlag.CLEAR ) !== 0;\r\n};\r\n\r\nexport class DControllerDefaultCommand extends utils.EventEmitter implements DControllerCommand {\r\n\tprotected _position: number;\r\n\tprotected _done: DCommand[];\r\n\tprotected _waiting: DCommand[];\r\n\tprotected _executing: Promise<void> | null;\r\n\r\n\tconstructor() {\r\n\t\tsuper();\r\n\r\n\t\tthis._position = 0;\r\n\t\tthis._done = [];\r\n\t\tthis._waiting = [];\r\n\t\tthis._executing = null;\r\n\t}\r\n\r\n\tlast(): DCommand | null {\r\n\t\tconst done = this._done;\r\n\t\tconst waiting = this._waiting;\r\n\r\n\t\tif( waiting.length <= 0 ) {\r\n\t\t\tif( 0 < done.length ) {\r\n\t\t\t\treturn done[ done.length - 1 ];\r\n\t\t\t} else {\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\treturn waiting[ waiting.length - 1 ];\r\n\t\t}\r\n\t}\r\n\r\n\tpush( command: DCommand ): void {\r\n\t\tconst waiting = this._waiting;\r\n\t\twaiting.push( command );\r\n\t\tthis.next();\r\n\t}\r\n\r\n\tnext() {\r\n\t\tif( this._executing == null ) {\r\n\t\t\tconst waiting = this._waiting;\r\n\t\t\tif( 0 < waiting.length ) {\r\n\t\t\t\tconst command = waiting.shift();\r\n\t\t\t\tif( command != null ) {\r\n\t\t\t\t\tif( command instanceof DCommandUndo ) {\r\n\t\t\t\t\t\tconst done = this._done;\r\n\t\t\t\t\t\tif( this._position < done.length ) {\r\n\t\t\t\t\t\t\tconst current = done[ done.length - 1 - this._position ];\r\n\t\t\t\t\t\t\tthis._position += 1;\r\n\t\t\t\t\t\t\tthis.emit( \"change\", this );\r\n\t\t\t\t\t\t\tconst result = current.undo();\r\n\t\t\t\t\t\t\tif( result === true ) {\r\n\t\t\t\t\t\t\t\tthis.onSuccess( command );\r\n\t\t\t\t\t\t\t} else if( result === false ) {\r\n\t\t\t\t\t\t\t\tthis.onFail( command );\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tthis._executing = result.then(() => {\r\n\t\t\t\t\t\t\t\t\tthis.onSuccess( command );\r\n\t\t\t\t\t\t\t\t}, () => {\r\n\t\t\t\t\t\t\t\t\tthis.onFail( command );\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if( command instanceof DCommandRedo ) {\r\n\t\t\t\t\t\tconst done = this._done;\r\n\t\t\t\t\t\tif( 0 < this._position ) {\r\n\t\t\t\t\t\t\tconst current = done[ done.length - this._position ];\r\n\t\t\t\t\t\t\tthis._position -= 1;\r\n\t\t\t\t\t\t\tthis.emit( \"change\", this );\r\n\t\t\t\t\t\t\tconst result = current.redo();\r\n\t\t\t\t\t\t\tif( result === true ) {\r\n\t\t\t\t\t\t\t\tthis.onSuccess( command );\r\n\t\t\t\t\t\t\t} else if( result === false ) {\r\n\t\t\t\t\t\t\t\tthis.onFail( command );\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tthis._executing = result.then(() => {\r\n\t\t\t\t\t\t\t\t\tthis.onSuccess( command );\r\n\t\t\t\t\t\t\t\t}, () => {\r\n\t\t\t\t\t\t\t\t\tthis.onFail( command );\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst isClear = isCommandClear( command );\r\n\t\t\t\t\t\tconst isStorable = isCommandStorable( command );\r\n\t\t\t\t\t\tif( isClear || isStorable ) {\r\n\t\t\t\t\t\t\tconst size = ( isClear ? this._done.length : this._position );\r\n\t\t\t\t\t\t\tif( 0 < size ) {\r\n\t\t\t\t\t\t\t\tthis.remove( size );\r\n\t\t\t\t\t\t\t\tthis._position = 0;\r\n\t\t\t\t\t\t\t\tthis.emit( \"change\", this );\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tthis.cleanup();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tconst result = command.execute();\r\n\t\t\t\t\t\tif( result === true ) {\r\n\t\t\t\t\t\t\tthis.onSuccess( command );\r\n\t\t\t\t\t\t} else if( result === false ) {\r\n\t\t\t\t\t\t\tthis.onFail( command );\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tthis._executing = result.then(() => {\r\n\t\t\t\t\t\t\t\tthis.onSuccess( command );\r\n\t\t\t\t\t\t\t}, () => {\r\n\t\t\t\t\t\t\t\tthis.onFail( command );\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprotected cleanup(): void {\r\n\t\tconst done = this._done;\r\n\t\tconst size = done.length - 100;\r\n\t\tif( 0 < size ) {\r\n\t\t\tfor( let i = 0; i < size; ++i ) {\r\n\t\t\t\tdone[ i ].destroy();\r\n\t\t\t\tdone.shift();\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprotected remove( size: number ): boolean {\r\n\t\tconst done = this._done;\r\n\t\tif( 0 < size ) {\r\n\t\t\tconst ifrom = Math.max( 0, done.length - size );\r\n\t\t\tsize = done.length - ifrom;\r\n\t\t\tif( 0 < size ) {\r\n\t\t\t\tfor( let i = ifrom, imax = done.length; i < imax; ++i ) {\r\n\t\t\t\t\tdone[ i ].destroy();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdone.splice( ifrom, done.length - ifrom );\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tprotected onSuccess( command: DCommand ) {\r\n\t\tthis._executing = null;\r\n\t\tif( isCommandStorable( command ) ) {\r\n\t\t\tthis._done.push( command );\r\n\t\t\tthis.emit( \"dirty\", this );\r\n\t\t} else if( command instanceof DCommandUndo || command instanceof DCommandRedo ) {\r\n\t\t\tthis.emit( \"dirty\", this );\r\n\t\t}\r\n\t\tthis.emit( \"change\", this );\r\n\t\tthis.next();\r\n\t}\r\n\r\n\tprotected onFail( command: DCommand ) {\r\n\t\tthis._executing = null;\r\n\t\tconst waiting = this._waiting;\r\n\t\tcommand.destroy();\r\n\t\tfor( let i = 0, imax = waiting.length; i < imax; ++i ) {\r\n\t\t\twaiting[ i ].destroy();\r\n\t\t}\r\n\t\twaiting.length = 0;\r\n\t\tthis.emit( \"change\", this );\r\n\t}\r\n\r\n\tsize(): number {\r\n\t\treturn this._done.length;\r\n\t}\r\n\r\n\tclear(): void {\r\n\t\tthis.push( new DCommandClear() );\r\n\t}\r\n\r\n\tredo(): void {\r\n\t\tif( this.isRedoable() ) {\r\n\t\t\tthis._waiting.push( new DCommandRedo() );\r\n\t\t\tthis.next();\r\n\t\t}\r\n\t}\r\n\r\n\tundo(): void {\r\n\t\tif( this.isUndoable() ) {\r\n\t\t\tthis._waiting.push( new DCommandUndo() );\r\n\t\t\tthis.next();\r\n\t\t}\r\n\t}\r\n\r\n\tisRedoable(): boolean {\r\n\t\treturn ( 0 < this._position && this._executing == null );\r\n\t}\r\n\r\n\tisUndoable(): boolean {\r\n\t\treturn ( this._position < this._done.length && this._executing == null );\r\n\t}\r\n}\r\n"]}