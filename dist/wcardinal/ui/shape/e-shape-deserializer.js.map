{"version":3,"file":"e-shape-deserializer.js","sourceRoot":"","sources":["../../../../src/main/typescript/wcardinal/ui/shape/e-shape-deserializer.ts"],"names":[],"mappings":"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","sourcesContent":["/*\r\n * Copyright (C) 2019 Toshiba Corporation\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\nimport { DDiagramSerializedItem } from \"../d-diagram-serialized\";\r\nimport { isString } from \"../util/is-string\";\r\nimport { EShapeActionValueDeserializer } from \"./action/e-shape-action-value-deserializer\";\r\nimport { EShape } from \"./e-shape\";\r\nimport { EShapeDeserializers } from \"./e-shape-deserializers\";\r\nimport { EShapeImageElements } from \"./e-shape-image-elements\";\r\nimport { EShapeResourceManagerDeserialization } from \"./e-shape-resource-manager-deserialization\";\r\nimport { EShapeSizes } from \"./e-shape-sizes\";\r\nimport { EShapeGradients } from \"./variant/e-shape-gradients\";\r\n\r\nexport class EShapeDeserializer {\r\n\tstatic toShape(\r\n\t\titem: DDiagramSerializedItem, manager: EShapeResourceManagerDeserialization\r\n\t): Promise<EShape> | EShape | null {\r\n\t\tconst shapeDeserializer = EShapeDeserializers[ item[ 0 ] ];\r\n\t\tif( shapeDeserializer != null ) {\r\n\t\t\treturn shapeDeserializer( item, manager );\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\tstatic deserialize<SHAPE extends EShape>(\r\n\t\titem: DDiagramSerializedItem, manager: EShapeResourceManagerDeserialization, result: SHAPE\r\n\t): Promise<SHAPE> | SHAPE {\r\n\t\tresult.id = manager.resources[ item[ 1 ] ] || \"\";\r\n\t\tresult.transform.position.set( item[ 2 ], item[ 3 ] );\r\n\t\tresult.transform.rotation = item[ 6 ];\r\n\t\tresult.transform.skew.set( item[ 7 ], item[ 7 ] );\r\n\t\tresult.transform.pivot.set( item[ 21 ], item[ 22 ] );\r\n\t\tresult.size.set( EShapeSizes.toNormalized( item[ 4 ] ), EShapeSizes.toNormalized( item[ 5 ] ) );\r\n\t\tresult.fill.deserialize( item[ 8 ], manager );\r\n\t\tresult.stroke.deserialize( item[ 9 ], manager );\r\n\t\tresult.cursor = manager.resources[ item[ 10 ] ] || \"\";\r\n\t\tresult.text.deserialize( item[ 11 ], manager );\r\n\t\tresult.tag.deserialize( item[ 12 ], manager );\r\n\t\tresult.radius = item[ 13 ];\r\n\t\tresult.corner = item[ 14 ];\r\n\t\tresult.interactive = !! ( item[ 23 ] & 1 );\r\n\t\tresult.unfocusable = !! ( item[ 23 ] & 2 );\r\n\t\tresult.shortcut = ( 0 <= item[ 24 ] ? manager.resources[ item[ 24 ] ] : undefined );\r\n\t\tresult.title = ( 0 <= item[ 25 ] ? manager.resources[ item[ 25 ] ] : undefined );\r\n\r\n\t\t// Children\r\n\t\tlet childrenPromise: Promise<SHAPE> | null = null;\r\n\t\tconst childrenSerialized = item[ 20 ];\r\n\t\tif( 0 < childrenSerialized.length ) {\r\n\t\t\tconst childrenOrPromises = [];\r\n\t\t\tfor( let i = 0, imax = childrenSerialized.length; i < imax; ++i ) {\r\n\t\t\t\tconst childSerialized = childrenSerialized[ i ];\r\n\t\t\t\tconst childOrPromise = EShapeDeserializer.toShape( childSerialized, manager );\r\n\t\t\t\tif( childOrPromise != null ) {\r\n\t\t\t\t\tchildrenOrPromises.push( childOrPromise );\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tchildrenPromise = Promise.all( childrenOrPromises ).then(( children: EShape[] ) => {\r\n\t\t\t\tresult.children = children;\r\n\t\t\t\tfor( let i = 0, imax = children.length; i < imax; ++i ) {\r\n\t\t\t\t\tchildren[ i ].parent = result;\r\n\t\t\t\t}\r\n\t\t\t\tresult.onChildTransformChange();\r\n\t\t\t\tresult.toDirty();\r\n\t\t\t\treturn result;\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t// Action\r\n\t\tconst serializedActions = item[ 17 ];\r\n\t\tfor( let i = 0, imax = serializedActions.length; i < imax; ++i ) {\r\n\t\t\tresult.action.add( EShapeActionValueDeserializer.deserialize( serializedActions[ i ], manager ) );\r\n\t\t}\r\n\r\n\t\t// Gradient\r\n\t\tconst gradientId = item[ 19 ];\r\n\t\tif( 0 <= gradientId && gradientId < manager.resources.length ) {\r\n\t\t\tconst gradient = manager.resources[ gradientId ];\r\n\t\t\tif( isString( gradient ) ) {\r\n\t\t\t\tresult.gradient = EShapeGradients.deserializeGradient( gradient );\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Image\r\n\t\tlet imagePromise: Promise<SHAPE> | null = null;\r\n\t\tconst imageId = item[ 18 ];\r\n\t\tif( 0 <= imageId && imageId < manager.resources.length ) {\r\n\t\t\tconst imageSrc = manager.resources[ imageId ];\r\n\t\t\tif( isString( imageSrc ) ) {\r\n\t\t\t\timagePromise = EShapeImageElements.toImageElement( imageSrc ).then(( imageElement ) => {\r\n\t\t\t\t\tresult.image = imageElement;\r\n\t\t\t\t\treturn result;\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//\r\n\t\tif( childrenPromise != null ) {\r\n\t\t\tif( imagePromise != null ) {\r\n\t\t\t\treturn Promise.all([ childrenPromise, imagePromise ]).then(() => {\r\n\t\t\t\t\treturn result;\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\treturn childrenPromise;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif( imagePromise != null ) {\r\n\t\t\t\treturn imagePromise;\r\n\t\t\t} else {\r\n\t\t\t\treturn result;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic deserializeAll( serializeds: DDiagramSerializedItem[], resources: string[] ): Promise<EShape[]> | null {\r\n\t\tconst manager = new EShapeResourceManagerDeserialization( resources );\r\n\t\tconst shapes: Array<Promise<EShape> | EShape> = [];\r\n\t\tfor( let i = 0, imax = serializeds.length; i < imax; ++i ) {\r\n\t\t\tconst serialized = serializeds[ i ];\r\n\t\t\tconst shape = EShapeDeserializer.toShape( serialized, manager );\r\n\t\t\tif( shape == null ) {\r\n\t\t\t\tif( 0 < shapes.length ) {\r\n\t\t\t\t\tPromise.all( shapes ).then( ( resolved: EShape[] ): void => {\r\n\t\t\t\t\t\tfor( let j = 0, jmax = resolved.length; j < jmax; ++j ) {\r\n\t\t\t\t\t\t\tresolved[ j ].destroy();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\r\n\t\t\tshapes.push( shape );\r\n\t\t}\r\n\t\tif( 0 < shapes.length ) {\r\n\t\t\treturn Promise.all( shapes );\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n}\r\n"]}