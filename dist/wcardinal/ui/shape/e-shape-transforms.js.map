{"version":3,"file":"e-shape-transforms.js","sourceRoot":"","sources":["../../../../src/main/typescript/wcardinal/ui/shape/e-shape-transforms.ts"],"names":[],"mappings":"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","sourcesContent":["/*\r\n * Copyright (C) 2019 Toshiba Corporation\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\nimport { Matrix } from \"pixi.js\";\r\nimport { EShape } from \"./e-shape\";\r\nimport { EShapeEditor } from \"./e-shape-editor\";\r\nimport { EShapeSizes } from \"./e-shape-sizes\";\r\nimport { EShapeBase } from \"./variant/e-shape-base\";\r\n\r\nexport class EShapeTransforms {\r\n\tstatic prepare( shape: EShape ): void {\r\n\t\tconst editor = shape.editor = (shape.editor || new EShapeEditor());\r\n\r\n\t\t// Ttransform\r\n\t\tshape.updateTransform();\r\n\t\tconst parent = shape.parent;\r\n\t\tif( parent instanceof EShapeBase ) {\r\n\t\t\tparent.transform.internalTransform.copyTo(editor.internalTransformParentInverse).invert();\r\n\t\t} else {\r\n\t\t\teditor.internalTransformParentInverse.identity();\r\n\t\t}\r\n\t\tshape.transform.internalTransform.copyTo(editor.internalTransform);\r\n\r\n\t\t// Rotation\r\n\t\teditor.rotation = shape.transform.rotation;\r\n\r\n\t\t// Size\r\n\t\teditor.size.copyFrom( shape.size );\r\n\r\n\t\t//\r\n\t\tshape.disallowOnTransformChange();\r\n\t}\r\n\r\n\tstatic finalize( shape: EShape ): void {\r\n\t\tshape.allowOnTransformChange( true );\r\n\t}\r\n\r\n\tstatic apply( shape: EShape, transform: Matrix, keepSize: boolean ): void {\r\n\t\tconst editor = shape.editor;\r\n\t\tif( editor != null ) {\r\n\t\t\tconst newLocalTransform = editor.localTransform;\r\n\t\t\teditor.internalTransformParentInverse.copyTo(newLocalTransform)\r\n\t\t\t\t.append(transform).append(editor.internalTransform);\r\n\t\t\tif( keepSize ) {\r\n\t\t\t\tthis.applyLocal( shape, newLocalTransform );\r\n\t\t\t} else {\r\n\t\t\t\tconst size = editor.size;\r\n\t\t\t\tthis.applyLocal( shape, newLocalTransform, size.x, size.y );\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tstatic applyLocal( shape: EShape, localTransform: Matrix, bx?: number, by?: number ): void {\r\n\t\tshape.disallowUploadedUpdate();\r\n\r\n\t\t// Reconstruct the position, the rotation and the size\r\n\t\tconst a = localTransform.a;\r\n\t\tconst b = localTransform.b;\r\n\t\tconst c = localTransform.c;\r\n\t\tconst d = localTransform.d;\r\n\t\tconst tx = localTransform.tx;\r\n\t\tconst ty = localTransform.ty;\r\n\r\n\t\t// Rotation\r\n\t\tconst transform = shape.transform;\r\n\t\tconst rx = Math.atan2(-c, d); // rotation - skewX\r\n\t\tconst ry = Math.atan2(+b, a); // rotation + skewY\r\n\t\ttransform.rotation = (rx + ry) * 0.5; // Here, assumes `skewX` === `skewY`\r\n\r\n\t\t// Skew\r\n\t\tconst skew = (ry - rx) * 0.5;\r\n\t\ttransform.skew.set(skew, skew);\r\n\r\n\t\t// Position: Assumes the pivot is invariant.\r\n\t\t// tx = position.x - (a * px + c * py)\r\n\t\t// ty = position.y - (b * px + d * py)\r\n\t\t//\r\n\t\t// Thus,\r\n\t\t// position.x = tx + (a * px + c * py)\r\n\t\t// position.y = ty + (b * px + d * py)\r\n\t\tconst pivot = transform.pivot;\r\n\t\tconst px = pivot.x;\r\n\t\tconst py = pivot.y;\r\n\t\ttransform.position.set(\r\n\t\t\ttx + (a * px + c * py),\r\n\t\t\tty + (b * px + d * py)\r\n\t\t);\r\n\r\n\t\t// Scale\r\n\t\tif( bx != null && by != null ) {\r\n\t\t\tconst sx = Math.sqrt( a * a + b * b );\r\n\t\t\tconst sy = Math.sqrt( c * c + d * d );\r\n\t\t\tshape.size.set(\r\n\t\t\t\tEShapeSizes.toNormalized( bx * sx ),\r\n\t\t\t\tEShapeSizes.toNormalized( by * sy )\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\t//\r\n\t\tshape.allowUploadedUpdate();\r\n\t}\r\n}\r\n"]}