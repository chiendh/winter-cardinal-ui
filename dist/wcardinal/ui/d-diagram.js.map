{"version":3,"file":"d-diagram.js","sourceRoot":"","sources":["../../../src/main/typescript/wcardinal/ui/d-diagram.ts"],"names":[],"mappings":"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","sourcesContent":["/*\r\n * Copyright (C) 2019 Toshiba Corporation\r\n * SPDX-License-Identifier: Apache-2.0\r\n */\r\n\r\nimport { interaction, Renderer } from \"pixi.js\";\r\nimport { DDiagramBase, DDiagramBaseOptions, DThemeDiagramBase } from \"./d-diagram-base\";\r\nimport { DDiagramCanvas, DDiagramCanvasOptions, DDiagramCanvasTagOptions } from \"./d-diagram-canvas\";\r\nimport { DDiagramSerialized } from \"./d-diagram-serialized\";\r\nimport { DDiagramShape } from \"./d-diagram-shape\";\r\nimport { DDiagramTag } from \"./d-diagram-tag\";\r\nimport { EShapeActionRuntime } from \"./shape/action/e-shape-action-runtime\";\r\nimport { EShapeActionRuntimeOpen } from \"./shape/action/e-shape-action-runtime-open\";\r\nimport { EShapeActionValue } from \"./shape/action/e-shape-action-value\";\r\nimport { EShape } from \"./shape/e-shape\";\r\nimport { EShapeRuntime } from \"./shape/e-shape-runtime\";\r\nimport { EShapeRuntimes } from \"./shape/e-shape-runtimes\";\r\nimport { UtilPointerEvent } from \"./util/util-pointer-event\";\r\n\r\nexport interface DDiagramOptions<\r\n\tTHEME extends DThemeDiagram = DThemeDiagram\r\n> extends DDiagramBaseOptions<DDiagramCanvas, THEME> {\r\n\ttag?: DDiagramCanvasTagOptions;\r\n}\r\n\r\nexport interface DThemeDiagram extends DThemeDiagramBase {\r\n\r\n}\r\n\r\nexport class DDiagram<\r\n\tTHEME extends DThemeDiagram = DThemeDiagram,\r\n\tOPTIONS extends DDiagramOptions<THEME> = DDiagramOptions<THEME>\r\n> extends DDiagramBase<DDiagramCanvas, THEME, OPTIONS> {\r\n\ttag: DDiagramTag;\r\n\tshape: DDiagramShape;\r\n\topener?: ( target: string ) => void;\r\n\r\n\tconstructor( options: OPTIONS ) {\r\n\t\tsuper( options );\r\n\r\n\t\t// Hover handling\r\n\t\tthis.on( UtilPointerEvent.move, ( e: interaction.InteractionEvent ): void => {\r\n\t\t\tif( UtilPointerEvent.contains( this, e.target ) ) {\r\n\t\t\t\tconst canvas = this.canvas;\r\n\t\t\t\tif( canvas ) {\r\n\t\t\t\t\tcanvas.onShapeMove( e );\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// Pointer down / up handling\r\n\t\tthis.on( UtilPointerEvent.up, ( e: interaction.InteractionEvent ): void => {\r\n\t\t\tif( UtilPointerEvent.contains( this, e.target ) ) {\r\n\t\t\t\tconst canvas = this.canvas;\r\n\t\t\t\tif( canvas ) {\r\n\t\t\t\t\tcanvas.onShapeUp( e );\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// Click handling\r\n\t\tthis.on( \"click\", ( e: interaction.InteractionEvent ): void => {\r\n\t\t\tif( UtilPointerEvent.contains( this, e.target ) ) {\r\n\t\t\t\tconst canvas = this.canvas;\r\n\t\t\t\tif( canvas ) {\r\n\t\t\t\t\tcanvas.onShapeClick( e );\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t//\r\n\t\tthis.tag = new DDiagramTag( this );\r\n\t\tthis.shape = new DDiagramShape( this );\r\n\t}\r\n\r\n\tprotected initialize( shapes: EShape[] ): void {\r\n\t\tconst formatterMap: { [format: string]: ( value: unknown ) => unknown } = {};\r\n\t\tconst initialMap: { [initial: string]: unknown | undefined } = {};\r\n\t\tconst actionMap: Map<EShapeActionValue, EShapeActionRuntime> = new Map<EShapeActionValue, EShapeActionRuntime>();\r\n\r\n\t\tfor( let i = 0, imax = shapes.length; i < imax; ++i ) {\r\n\t\t\tconst shape = shapes[ i ];\r\n\t\t\tconst runtimeConstructor = EShapeRuntimes[ shape.type ] || EShapeRuntime;\r\n\t\t\tconst runtime = shape.runtime = new (runtimeConstructor)( shape );\r\n\r\n\t\t\t// Tag\r\n\t\t\tconst tag = shape.tag;\r\n\t\t\tfor( let j = 0, jmax = tag.size(); j < jmax; ++j ) {\r\n\t\t\t\tconst value = tag.get( j );\r\n\t\t\t\tif( value ) {\r\n\t\t\t\t\t// Format\r\n\t\t\t\t\tconst tagFormat = value.format;\r\n\t\t\t\t\tconst tagInitial = value.initial;\r\n\t\t\t\t\tif( tagFormat in formatterMap ) {\r\n\t\t\t\t\t\tvalue.formatter = formatterMap[ tagFormat ];\r\n\t\t\t\t\t} else if( 0 < tagFormat.length ) {\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tconst formatter = Function(\r\n\t\t\t\t\t\t\t\t\"value\",\r\n\t\t\t\t\t\t\t\t`try {` +\r\n\t\t\t\t\t\t\t\t\t`return (${tagFormat});` +\r\n\t\t\t\t\t\t\t\t`} catch( e1 ) {` +\r\n\t\t\t\t\t\t\t\t\t`try {` +\r\n\t\t\t\t\t\t\t\t\t\t`return (${0 < tagInitial.length ? tagInitial : 0});` +\r\n\t\t\t\t\t\t\t\t\t`} catch( e2 ) {` +\r\n\t\t\t\t\t\t\t\t\t\t`return 0;` +\r\n\t\t\t\t\t\t\t\t\t`}` +\r\n\t\t\t\t\t\t\t\t`}`\r\n\t\t\t\t\t\t\t) as any;\r\n\t\t\t\t\t\t\tformatterMap[ tagFormat ] = formatter;\r\n\t\t\t\t\t\t\tvalue.formatter = formatter;\r\n\t\t\t\t\t\t} catch( e ) {\r\n\t\t\t\t\t\t\t//\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Initial\r\n\t\t\t\t\tif( tagInitial in initialMap ) {\r\n\t\t\t\t\t\tvalue.value = initialMap[ tagInitial ];\r\n\t\t\t\t\t} else if( 0 < tagInitial.length ) {\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tvalue.value = initialMap[ tagInitial ] = (Function(\r\n\t\t\t\t\t\t\t\t`try {` +\r\n\t\t\t\t\t\t\t\t\t`return (${tagInitial});` +\r\n\t\t\t\t\t\t\t\t`} catch( e ) {` +\r\n\t\t\t\t\t\t\t\t\t`return 0;` +\r\n\t\t\t\t\t\t\t\t`}`\r\n\t\t\t\t\t\t\t)());\r\n\t\t\t\t\t\t} catch( e ) {\r\n\t\t\t\t\t\t\t//\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Initialize runtime actions\r\n\t\t\tconst values = shape.action.values;\r\n\t\t\tconst actions = runtime.actions;\r\n\t\t\tfor( let j = 0, jmax = values.length; j < jmax; ++j ) {\r\n\t\t\t\tconst value = values[ j ];\r\n\t\t\t\tlet action: EShapeActionRuntime | undefined | null = actionMap.get( value );\r\n\t\t\t\tif( action == null ) {\r\n\t\t\t\t\taction = value.toRuntime( shape );\r\n\t\t\t\t\tif( action != null ) {\r\n\t\t\t\t\t\tif( action instanceof EShapeActionRuntimeOpen ) {\r\n\t\t\t\t\t\t\tif( shape.cursor.length <= 0 ) {\r\n\t\t\t\t\t\t\t\tshape.cursor = \"pointer\";\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tactionMap.set( value, action );\r\n\t\t\t\t\t\tactions.push( action );\r\n\t\t\t\t\t\truntime.reset |= action.reset;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tactions.push( action );\r\n\t\t\t\t\truntime.reset |= action.reset;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Children\r\n\t\t\tconst children = shape.children;\r\n\t\t\tif( 0 < children.length ) {\r\n\t\t\t\tthis.initialize( children );\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tprotected newCanvas( serialized: DDiagramSerialized ): DDiagramCanvas {\r\n\t\treturn new DDiagramCanvas( this.toCanvasOptions( serialized ) );\r\n\t}\r\n\r\n\tprotected toCanvasOptions( serialized: DDiagramSerialized ): DDiagramCanvasOptions {\r\n\t\tconst options = this._options;\r\n\t\treturn {\r\n\t\t\tname: serialized.name,\r\n\t\t\twidth: serialized.width,\r\n\t\t\theight: serialized.height,\r\n\t\t\tbackground: {\r\n\t\t\t\tcolor: null\r\n\t\t\t},\r\n\t\t\tborder: {\r\n\t\t\t\tcolor: null\r\n\t\t\t},\r\n\t\t\ttile: {\r\n\t\t\t\tfactory: this._tileFactory,\r\n\t\t\t\tmapping: serialized.tile && serialized.tile.mapping\r\n\t\t\t},\r\n\t\t\ttag: options && options.tag\r\n\t\t};\r\n\t}\r\n\r\n\tprotected onDown( e: interaction.InteractionEvent ): void {\r\n\t\tconst canvas = this.canvas;\r\n\t\tif( canvas && canvas.onShapeDown( e ) ) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tsuper.onDown( e );\r\n\t}\r\n\r\n\tonDblClick( e: MouseEvent | TouchEvent, interactionManager: interaction.InteractionManager ): boolean {\r\n\t\tconst canvas = this.canvas;\r\n\t\tif( canvas && canvas.onShapeDblClick( e, interactionManager ) ) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn super.onDblClick( e, interactionManager );\r\n\t}\r\n\r\n\trender( renderer: Renderer ): void {\r\n\t\tthis.shape.update();\r\n\t\tsuper.render( renderer );\r\n\t}\r\n\r\n\tprotected getType(): string {\r\n\t\treturn \"DDiagram\";\r\n\t}\r\n}\r\n"]}